AWSTemplateFormatVersion: "2010-09-09"

Description: PasseUnDessin Api - IAM Roles

Parameters:
  Env:
    Type: String
    Default: staging

Resources:
  PasseUnDessinApiEC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub passe-un-dessin-api-ec2-role-${Env}
      Path: /
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role

  PasseUnDessinApiEC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub passe-un-dessin-api-ec2-instance-profile-${Env}
      Path: /
      Roles:
        - !Ref PasseUnDessinApiEC2Role

  PasseUnDessinApiAutoScaleRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub passe-un-dessin-api-autoscale-role-${Env}
      Path: /
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "application-autoscaling.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceAutoscaleRole

  PasseUnDessinApiTaskRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: !Sub passe-un-dessin-api-task-role-${Env}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ecs-tasks.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: /
      Policies:
        - PolicyName: !Sub LogAuthorization-${Env}
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "logs:CreateLogGroup"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"
        - PolicyName: !Sub S3Access-${Env}
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "s3:*"
                Resource:
                  - "*"

Outputs:
  PasseUnDessinApiEC2Role:
    Value: !Ref PasseUnDessinApiEC2Role
  PasseUnDessinApiEC2InstanceProfile:
    Value: !Ref PasseUnDessinApiEC2InstanceProfile
  PasseUnDessinApiAutoScaleRole:
    Value: !Ref PasseUnDessinApiAutoScaleRole
  PasseUnDessinApiTaskRole:
    Value: !Ref PasseUnDessinApiTaskRole
